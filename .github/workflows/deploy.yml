name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["All Ride Interview Frontend CI"]
    types:
      - completed
    branches:
      - main
      - 'devops/**'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: ðŸ›‘ Fail early if no artifact name file is found
        run: |
          if [ ! -f artifact-name.txt ]; then
            echo "Artifact name file missing. Cannot proceed."
            exit 1
          fi

      - name: ðŸ“¥ Download Artifact Metadata (Name)
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: "All Ride Interview Frontend CI"
          branch: main
          name: artifact-name
          path: meta

      - name: ðŸ§¾ Read Artifact Name
        id: read_name
        run: |
          ARTIFACT_NAME=$(cat meta/artifact-name.txt)
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Download Build Artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: "All Ride Interview Frontend CI"
          branch: main
          name: ${{ steps.read_name.outputs.artifact_name }}
          path: build

      - name: ðŸ”§ Setup Pages
        uses: actions/configure-pages@v5

      - name: ðŸ“¤ Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
